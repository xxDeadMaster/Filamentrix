<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Filamentrix</title>
<style>
body { font-family: system-ui, sans-serif; background:#0a0a0a; color:#e0e0e0; padding:16px; display:flex; flex-direction:column; min-height:100vh; }
header { display:flex; align-items:center; justify-content:space-between; margin-bottom:16px; }
header h1 { color:#b855f7; font-size:1.6rem; margin:0; }
.camera-btn { background: #b855f7; border:none; border-radius:50%; width:50px; height:50px; cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:24px; transition:0.2s; }
.camera-btn:hover { background:#ff55aa; }
.card { background:#1a1a1a; padding:16px; border-radius:12px; margin-bottom:16px; box-shadow:0 0 10px rgba(184,85,247,0.3); }
label { display:block; margin-top:10px; font-size:0.75rem; opacity:0.8; }
input, select, textarea, button { width:100%; padding:8px; margin-top:4px; border-radius:8px; border:none; background:#222; color:#e0e0e0; }
textarea { resize:none; }
button { background:#b855f7; cursor:pointer; margin-top:12px; transition:0.2s; }
button:hover { background:#ff55aa; }
.color-grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(70px,1fr)); gap:10px; margin-top:10px; }
.color-box { height:60px; border-radius:10px; cursor:pointer; display:flex; flex-direction:column; justify-content:flex-end; padding:6px; font-size:0.65rem; position:relative; background:linear-gradient(135deg,#b855f7,#ff55aa); transition:transform 0.2s; color:#fff; }
.color-box:hover { transform:scale(1.05); }
.color-box .tooltip { visibility:hidden; background:rgba(20,20,20,0.95); color:#ff55aa; text-align:left; border-radius:6px; padding:6px; font-size:0.7rem; position:absolute; z-index:1; bottom:70px; left:50%; transform:translateX(-50%); white-space:pre-wrap; max-width:150px; }
.color-box:hover .tooltip { visibility:visible; }
.low-stock { animation: flash 1s infinite; }
@keyframes flash { 0% { box-shadow:0 0 5px #ff4444; } 50% { box-shadow:0 0 15px #ff4444; } 100% { box-shadow:0 0 5px #ff4444; } }
.modal { position:fixed; inset:0; background:rgba(0,0,0,0.85); display:none; align-items:center; justify-content:center; }
.modal-content { background:#1a1a1a; padding:16px; border-radius:16px; width:90%; max-width:360px; position:relative; }
#cameraOverlay { display:none; position:fixed; top:60px; right:16px; background:#1a1a1a; padding:10px; border-radius:12px; box-shadow:0 0 10px rgba(184,85,247,0.3); z-index:999; width:220px; text-align:center; }
#sample-dot { width:40px; height:40px; border-radius:50%; border:2px solid #fff; margin:0 auto; margin-top:6px; }
.status { font-size:0.8rem; margin-top:6px; }
footer { text-align:center; font-size:0.75rem; opacity:0.7; margin-top:auto; padding-top:10px; color:#ff55aa; }
#syncCode, #pasteSync { background:#222; border:1px solid #b855f7; color:#fff; font-size:0.7rem; padding:6px; border-radius:6px; font-family:monospace; overflow-wrap:anywhere; }
#pasteSync { width:100%; height:50px; resize:none; margin-top:4px; }
</style>
</head>
<body>
<header>
  <h1>Filamentrix</h1>
  <button class="camera-btn" title="Camera Deduct" onclick="toggleCamera()">ðŸ“·</button>
</header>

<!-- Upgraded Summary Card -->
<div class="card" id="summaryCard">
  <h2 style="font-size:0.95rem;">Summary</h2>
  <p id="totalSpools">Total Spools: 0</p>
  <p id="totalQuantity">Total Quantity: 0</p>
  <p id="lowStock">Low Stock: None</p>
  <p id="mostUsedMaterial">Most Used Material: N/A</p>
  <p id="recentlyAdded">Recently Added: None</p>
</div>

<!-- Add / Update Filament -->
<div class="card">
  <h2 style="font-size:0.95rem;">Add / Update Filament</h2>
  <label>Filament Name</label>
  <input id="filamentName" placeholder="e.g. eSUN PLA+" />
  <label>Filament Color</label>
  <input id="colorName" placeholder="e.g. Matte Black" type="color"/>
  <label>Quantity</label>
  <input id="quantityInput" type="number" value="1" min="1" />
  <button onclick="addOrUpdateFilament()">Save</button>
  <div class="color-grid" id="colorGrid"></div>
  <p style="font-size:0.7rem;opacity:0.6;margin-top:6px;">Tap a color to edit details.</p>

  <!-- Offline Sync -->
  <div>
    <h3 style="font-size:0.8rem; margin-top:10px;">Offline Sync</h3>
    <button onclick="generateSyncCode()" style="width:100%">Generate Code</button>
    <div id="syncCode"></div>
    <textarea id="pasteSync" placeholder="Paste code here to sync"></textarea>
    <button onclick="applySyncCode()" style="width:100%; margin-top:4px;">Apply Pasted Code</button>
    <p style="font-size:0.7rem; opacity:0.6;">Use this to sync inventory across devices.</p>
  </div>
</div>

<!-- Modal for editing filament -->
<div class="modal" id="detailModal">
  <div class="modal-content">
    <h3 id="modalTitle" style="font-size:0.9rem;"></h3>
    <label>Material</label>
    <select id="material">
      <option>PLA</option><option>PETG</option><option>ABS</option><option>TPU</option><option>Nylon</option>
    </select>
    <label>Nozzle Temp</label>
    <input id="nozzleTemp" />
    <label>Bed Temp</label>
    <input id="bedTemp" />
    <label>Quantity</label>
    <input id="quantity" type="number" min="1" />
    <label>Notes</label>
    <textarea id="notes" rows="2"></textarea>
    <button onclick="saveModal()">Save</button>
    <button onclick="deleteFilament()" style="background:#922;">Delete</button>
    <button onclick="closeModal()" style="background:#333;">Close</button>
  </div>
</div>

<!-- AI Camera Overlay -->
<div id="cameraOverlay">
  <video id="video" autoplay playsinline style="width:100%; border-radius:12px;"></video>
  <div class="viewfinder" style="position:absolute; top:50%; left:50%; width:50px; height:50px; margin-left:-25px; margin-top:-25px; border:2px solid #b855f7; border-radius:8px; pointer-events:none;"></div>
  <div id="sample-dot"></div>
  <p id="aiResult" class="status"></p>
  <div id="aiActions" style="margin-top:6px; display:flex; flex-direction:column; gap:6px;">
    <button id="btn-deduct" onclick="deductColor()" disabled>Deduct This Color</button>
    <button onclick="toggleCamera()" style="background:#333; color:#fff; border-radius:8px; padding:6px;">Close</button>
  </div>
</div>

<!-- Settings button fixed below the Add/Update Filament card -->
<button onclick="toggleSettings()" style="width:100%; padding:10px; border-radius:8px; background:#b855f7; margin-top:10px; font-size:1rem;">Settings</button>

<!-- Settings Modal -->
<div class="modal" id="settingsModal">
  <div class="modal-content">
    <h3>Settings</h3>
    <h4>App Behavior / UI</h4>
    <label>Theme</label>
    <select id="uiTheme">
      <option value="dark">Dark</option>
      <option value="light">Light</option>
    </select>
    <h4>Filament Defaults</h4>
    <label>Default Material</label>
    <select id="defaultMaterial">
      <option>PLA</option><option>PETG</option><option>ABS</option><option>TPU</option><option>Nylon</option>
    </select>
    <h4>AI Camera</h4>
    <label>Sensitivity (0-255)</label>
    <input id="aiSensitivity" type="number" min="0" max="255" value="150" />
    <button onclick="recalibrateAI()">Recalibrate AI</button>
    <h4>Miscellaneous</h4>
    <p>App Version: 1.0.0</p>
    <button onclick="closeSettings()" style="background:#333;">Close</button>
  </div>
</div>

<footer>Made with love by XxDeadMaster's Printing Lair</footer>

<script>
// Inventory and AI vars
let inventory = [];
let stream = null;
let sampler = null;
let matchedItem = null;

// Add / Update Filament
function addOrUpdateFilament(){
  const name = document.getElementById('filamentName').value.trim();
  const color = document.getElementById('colorName').value.trim();
  const quantity = parseInt(document.getElementById('quantityInput').value);
  if(!name || !color || isNaN(quantity) || quantity<1){alert('Please enter valid name, color, and quantity'); return;}
  const existing = inventory.find(f=>f.name===name && f.color===color);
  if(existing){existing.quantity+=quantity;}
  else{inventory.push({name,color,quantity,hex:color,material:'PLA',nozzleTemp:'',bedTemp:'',notes:''});}
  document.getElementById('filamentName').value='';
  document.getElementById('colorName').value='#000000';
  document.getElementById('quantityInput').value=1;
  renderInventory();
}

// Render Inventory
function renderInventory(){
  const grid=document.getElementById('colorGrid');
  grid.innerHTML='';
  inventory.forEach(item=>{
    const box=document.createElement('div');
    box.className='color-box';
    box.style.background=item.hex;
    if(item.quantity<=1){box.classList.add('low-stock');}
    box.innerHTML=`<span>${item.color} (${item.quantity})</span><div class="tooltip">Material: ${item.material}\nNozzle: ${item.nozzleTemp}\nBed: ${item.bedTemp}\nNotes: ${item.notes}</div>`;
    box.onclick=()=>openModal(item);
    grid.appendChild(box);
  });
  updateSummary();
}

// Upgraded Summary
function updateSummary(){
  document.getElementById('totalSpools').innerText = `Total Spools: ${inventory.length}`;
  const totalQty = inventory.reduce((sum,it)=>sum+it.quantity,0);
  document.getElementById('totalQuantity').innerText = `Total Quantity: ${totalQty}`;

  const lowStockItems = inventory.filter(it=>it.quantity<=3);
  document.getElementById('lowStock').innerText = lowStockItems.length ? 'Low Stock: '+lowStockItems.map(it=>`${it.color} (${it.name})`).join(', ') : 'Low Stock: None';

  const materialCount={};
  inventory.forEach(it=>materialCount[it.material]=(materialCount[it.material]||0)+1);
  let mostUsed='N/A', maxCount=0;
  for(const mat in materialCount){if(materialCount[mat]>maxCount){maxCount=materialCount[mat];mostUsed=mat;}}
  document.getElementById('mostUsedMaterial').innerText=`Most Used Material: ${mostUsed}`;

  const recent = inventory.slice(-3).map(it=>`${it.color} (${it.name})`);
  document.getElementById('recentlyAdded').innerText = recent.length ? `Recently Added: ${recent.join(', ')}` : 'Recently Added: None';
}

// Offline Sync
function generateSyncCode(){document.getElementById('syncCode').innerText=JSON.stringify(inventory);}
function applySyncCode(){try{const pasted=JSON.parse(document.getElementById('pasteSync').value);if(Array.isArray(pasted)){inventory=pasted;renderInventory();alert('Inventory synced successfully');}else{alert('Invalid code');}}catch(e){alert('Invalid code');}}

// AI Camera
async function toggleCamera(){
  const video=document.getElementById('video');
  if(!stream){
    try{
      stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
      video.srcObject=stream;
      startAILoop();
      document.getElementById('cameraOverlay').style.display='block';
    }catch(e){console.error('CAMERA_ERROR: Check permissions.'); alert('Camera not available or permission denied');}
  }else{
    stream.getTracks().forEach(t=>t.stop());
    stream=null;
    clearInterval(sampler);
    document.getElementById('cameraOverlay').style.display='none';
  }
}

function startAILoop(){
  const video=document.getElementById('video');
  const canvas=document.createElement('canvas');
  const ctx=canvas.getContext('2d',{willReadFrequently:true});
  sampler=setInterval(()=>{
    if(!video||video.paused||video.ended) return;
    canvas.width=20; canvas.height=20;
    ctx.drawImage(video,video.videoWidth/2-10,video.videoHeight/2-10,20,20,0,0,20,20);
    const data=ctx.getImageData(0,0,20,20).data;
    let r=0,g=0,b=0;
    for(let i=0;i<data.length;i+=4){r+=data[i];g+=data[i+1];b+=data[i+2];}
    r=Math.floor(r/(data.length/4)); g=Math.floor(g/(data.length/4)); b=Math.floor(b/(data.length/4));
    const hex=`#${((1<<24)+(r<<16)+(g<<8)+b).toString(16).slice(1)}`;
    document.getElementById('sample-dot').style.backgroundColor=hex;
    let bestMatch=null; let minDistance=parseInt(document.getElementById('aiSensitivity').value)||150;
    inventory.forEach(item=>{
      const ir=parseInt(item.hex.substring(1,3),16);
      const ig=parseInt(item.hex.substring(3,5),16);
      const ib=parseInt(item.hex.substring(5,7),16);
      const d=Math.sqrt(Math.pow(r-ir,2)+Math.pow(g-ig,2)+Math.pow(b-ib,2));
      if(d<minDistance){minDistance=d; bestMatch=item;}
    });
    matchedItem=bestMatch;
    const matchDisplay=document.getElementById('aiResult');
    const deductBtn=document.getElementById('btn-deduct');
    if(matchedItem){matchDisplay.innerText=`${matchedItem.color} (${matchedItem.name}) - Qty: ${matchedItem.quantity}`; deductBtn.disabled=false;}
    else{matchDisplay.innerText='SEARCHING...'; deductBtn.disabled=true;}
  },400);
}

function deductColor(){if(matchedItem){matchedItem.quantity=Math.max(0,matchedItem.quantity-1);renderInventory();}}

// Modal Functions
function openModal(item){
  document.getElementById('detailModal').style.display='flex';
  document.getElementById('modalTitle').innerText=`${item.color} (${item.name})`;
  document.getElementById('material').value=item.material;
  document.getElementById('nozzleTemp').value=item.nozzleTemp;
  document.getElementById('bedTemp').value=item.bedTemp;
  document.getElementById('quantity').value=item.quantity;
  document.getElementById('notes').value=item.notes;
  matchedItem=item;
}
function saveModal(){if(matchedItem){matchedItem.material=document.getElementById('material').value; matchedItem.nozzleTemp=document.getElementById('nozzleTemp').value; matchedItem.bedTemp=document.getElementById('bedTemp').value; matchedItem.quantity=parseInt(document.getElementById('quantity').value)||matchedItem.quantity; matchedItem.notes=document.getElementById('notes').value; renderInventory(); closeModal();}}
function deleteFilament(){if(matchedItem){inventory=inventory.filter(it=>it!==matchedItem); renderInventory(); closeModal();}}
function closeModal(){document.getElementById('detailModal').style.display='none'; matchedItem=null;}

// Settings Panel
function toggleSettings(){document.getElementById('settingsModal').style.display='flex';}
function closeSettings(){document.getElementById('settingsModal').style.display='none';}
function recalibrateAI(){alert('AI camera recalibrated!');}

</script>
</body>
</html>
